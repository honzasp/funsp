\chapter{Krunimír: želví grafika}

\begin{quotation}

Želvák Krunimír je velký myslitel. Zjistil, ze když si za krunýř přiváže trochu
křídy, kreslí za sebou při svém plazení cestičku. I pojal plán nakreslit svoji
podobiznu, samozřejmě včetně přesných detailů krunýře. Hned se dal pln nadšení
do díla a práce mu šla pěkně od ... tlapy.

\uv{Co to děláš, dědečku,} zeptal se jednou Krunimíra jeho vnuk Krunoslav.
\uv{Krešlím tady švou poďobižnu,} odpověděl Krunimír. \uv{Žačal jsem š ní, když
tvůj tatík ještě nebyl na švětě, a ještě nemám ani krunýř,} dodal smutně. \uv{To
už ji aši dokrešlit neštihnu...}  Vnuk Krunoslav, znalec moderní techniky, mu
však poradil: \uv{Tak si nech napsat program, který ji nakreslí za Tebe.}
Protože se ale s tlapami a zobákem moc dobře neprogramuje, najali si želváci
vás.

\end{quotation}

Takto začíná zadání finální úlohy Soutěže v programování z roku 2010. Popisuje
jednoduchý procedurální jazyk na generování želví grafiky, inspirovaný jazykem
Logo, a úkolem je vytvořit interpret tohoto jazyka, jehož vstupem je text
programu a výstupem obrázek s vykresleným výsledkem.

\section{Popis jazyka}

Uživatel má k dispozici několik primitivních kreslících funkcí:

\begin{description}
\item[\texttt{forward(d)}] Želva se posune vpřed o \texttt{d} jednotek (pixelů).
Pokud je tloušťka pera kladná, zanechá za sebou čáru vedoucí z původní pozice do
nové. Takovýto pohyb se považuje za jeden \emph{tah}.
\item[\texttt{right(a)}, \texttt{left(a)}] Želva se otočí doprava, resp. doleva o
\texttt{a} stupňů.
\item[\texttt{pen(s)}] Nastaví tloušťku pera na \texttt{s}
\item[\texttt{color(r, g, b)}] Nastaví barvu pera, \texttt{r}, \texttt{g} a
\texttt{b} jsou jednotlivé složky modelu RGB v rozsahu 0 až 255.
\end{description}

Jazyk dále umožňuje použít jednoduchou podmínku a cyklus:

\begin{description}
\item[\texttt{if(x) \{ ... \}}] Vykoná příkazy v těle podmínky právě když je
\texttt{x} kladné.
\item[\texttt{repeat(x) \{ ... \}}] Vykoná příkazy \texttt{x}-krát, je-li
\texttt{x} kladné.
\end{description}

Uživatel může definovat vlastní procedury a volat je:

\begin{description}

\item[\texttt{define 
  \textit{procedura}(\textit{p1},\textit{p2},...)
  \{ ... \}
}]
  Definuje proceduru \textit{procedura}, která má libovolný počet parametrů
  (\textit{p1}, \textit{p2}, ...). Tyto parametry mohou být v těle procedury
  použity ve výrazech a nabývají hodnoty předané v místě volání.

\item[\texttt{\textit{procedura}(\textit{arg1},\textit{arg2},...)}]
  Zavolá proceduru \textit{procedura} s argumenty (\textit{arg1}, \textit{arg2},
  ...). Procedura musí být definována \textit{před} svým voláním a může být
  rekurzivní.

\end{description}

Poslední a nejzajímavější struktura je rozdvojení:

\begin{description}
\item[\texttt{split \{ ... \}}] Vytvoří klon aktuální želvy, která vykoná
příkazy v těle struktury \texttt{split}, přičemž původní želva pokračuje ve vykonávání
dalších příkazů. Všechny želvy se pohybují paralelně, vždy všechny provedou
jeden \emph{krok}, poté druhý atd.
\end{description}

Jako argumenty při volání procedur lze používat výrazy vytvořené z celočíselných
literálů, parametrů aktuální funkce, binárních operátorů \texttt{+}, \texttt{-},
\texttt{*} a \texttt{/} (celočíselné dělení) a negace pomocí operátoru
\texttt{-}. Ve výrazech je možno používat závorky \texttt{(} a \texttt{)},
priorita a asociativita operátorů je jako v matematice.

\subsection{Příklady}

\subsubsection{Kreslení čtverce}

\begin{verbatim}
pen(1)
repeat(4) { forward(100) right(90) }
\end{verbatim}


\section{Analýza}

Problém si můžeme rozdělit na tři části:

\begin{enumerate}

\item \emph{Syntaktická analýza} (\uv{parsování}) zpracuje vstupní řetězec na
  \emph{abstraktní syntaktický strom}, který zachycuje strukturu programu ve
  formě, která je jednoduše zpracovatelná v dalších fázích.

\item Následuje \emph{vyhodnocení}, kdy ze syntaktického stromu vypočteme
  výsledný obrázek (ve vektorové podobě jako seznam úseček).

\item Poslední částí je \emph{vykreslení}, které vykreslí vyhodnocený obrázek do
  formátu PNG.

\end{enumerate}

Pomocí tohoto jednoduchého rozdělení můžeme naše řešení rozvrhnout do šesti
modulů:

\begin{description}

\item \texttt{Krunimir.Main} exportuje \texttt{main}, která slouží jako rozhraní s
uživatelem. \footnote{Podobně jako funkce \texttt{main()} v jazyku C}

\item \texttt{Krunimir.Parser} exportuje funkci \texttt{parse}, která z textového
zápisu programu vytvoří syntaktický strom (nebo syntaktickou chybu).

\item \texttt{Krunimir.Ast} definuje datové typy, které reprezentují syntaktický
strom.

\item \texttt{Krunimir.Evaluator} poskytuje funkci \texttt{eval}, která ze
syntaktického stromu vypočte výsledný obrázek.

\item \texttt{Krunimir.Image} definuje datové typy a funkce spojené s obrázky.

\item \texttt{Krunimir.Renderer} exportuje funkci \texttt{render}, která vykreslí PNG
obrázek do souboru.

\end{description}

\input{krunimir/Krunimir/Main.lhs}
\input{krunimir/Krunimir/Ast.lhs}
\input{krunimir/Krunimir/Parser.lhs}
